{% extends "base.html" %}
{% block title %}Merge PDFs{% endblock %}
{% block content %}
      <div class="app-header">
        <div>
          <h1>Merge PDFs</h1>
          <div class="app-sub">Upload multiple PDFs, preview them, and merge into a single file.</div>
        </div>
      </div>

      <div class="card">
        <div class="form-grid">
              
          <form id="merge-form" method="post" action="/merge" enctype="multipart/form-data">
            <div class="input-row">
              <label class="small">PDF Files (multiple)</label>
              <input id="files-input" type="file" name="files" multiple accept="application/pdf" required style="display:none" />
              <button type="button" id="add-more-files" class="btn" style="background:#059669">+ Add files</button>
              <ul id="selected-files" class="file-list" aria-live="polite"></ul>

              <label class="small">Output File Name (optional)</label>
              <input id="output-filename" type="text" name="output_filename" placeholder="e.g. combined.pdf" style="width:100%;max-width:300px" />
              <div class="small" style="color:#666;margin-top:0.25rem">.pdf extension will be added if not provided</div>

              <label class="small" style="margin-top:0.5rem">Global Page Size (optional)</label>
              <div style="display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap">
                <select id="page-size-select" style="flex:1;min-width:180px">
                  <option value="">Preserve original</option>
                  <option value="largest">Largest</option>
                  <option value="smallest">Smallest</option>
                  <option value="first">First</option>
                  <option value="A4">A4 (210√ó297 mm)</option>
                  <option value="Letter">Letter (8.5√ó11 in)</option>
                  <option value="custom">Custom</option>
                </select>
                <input id="page-size-custom" type="text" placeholder="e.g. 8.5inx11in" style="flex:1;min-width:180px;display:none" />
              </div>
              <input type="hidden" name="page_size" id="page-size-hidden" value="" />

              <div style="margin-top:0.5rem;display:flex;flex-wrap:wrap;gap:0.5rem;align-items:center">
                <button id="merge-button" class="btn" type="submit">Merge</button>
                <span class="small">Note: files with 'Use global' will use the global page size above.</span>
              </div>
            
            </div>
          </form>
        </div>

        <div style="margin-top:0.75rem;display:flex;gap:0.5rem;flex-wrap:wrap;align-items:center">
          <a id="merged-download" class="download-link" style="display:none" download="merged.pdf">Download merged PDF</a>
          <button type="button" id="upload-to-drive-btn" class="btn" style="background:#1e88e5;display:none">üì§ Upload to Drive</button>
          <button type="button" id="share-whatsapp-btn" class="btn" style="background:#25d366;display:none">üí¨ Share to WhatsApp</button>
        </div>

        <div id="drive-folder-section" style="margin-top:0.75rem;padding:0.75rem;background:#f5f5f5;border-radius:4px;display:none">
          <div class="small" style="margin-bottom:0.5rem;font-weight:600">Google Drive Folder</div>
          <div style="display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;margin-bottom:0.5rem">
            <select id="folder-select" style="flex:1;min-width:200px">
              <option value="">Root folder</option>
            </select>
            <button type="button" id="refresh-folders-btn" class="btn" style="background:#666;padding:0.4rem 0.8rem;font-size:0.85rem">üîÑ Refresh</button>
          </div>
          <div style="display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap">
            <input id="new-folder-name" type="text" placeholder="New folder name..." style="flex:1;min-width:150px" />
            <button type="button" id="create-folder-btn" class="btn" style="background:#059669;padding:0.4rem 0.8rem;font-size:0.85rem">‚ûï Create Folder</button>
          </div>
          <div id="folder-status" class="small" style="margin-top:0.5rem;color:#666"></div>
        </div>

        <div style="margin-top:0.75rem">
          <div class="previews-row">
            <div style="flex:1 1 520px">
              <div class="preview-title">Selected file preview <button type="button" class="zoom-toggle" data-target="selected-preview" aria-pressed="false">üîç Fit to width</button></div>
              <div class="preview-frames preview" aria-label="Selected file preview">
                <iframe id="selected-preview" style="display:none" title="Selected file preview" aria-label="Selected file preview" data-zoom="page-width"></iframe>
              </div>
            </div>

            <div style="flex:1 1 520px">
              <div class="preview-title">Merged PDF preview <button type="button" class="zoom-toggle" data-target="merged-preview" aria-pressed="false">üîç Fit to width</button></div>
              <div class="preview-frames preview" aria-label="Merged PDF preview">
                <iframe id="merged-preview" style="display:none" title="Merged PDF preview" aria-label="Merged PDF preview" data-zoom="page-width"></iframe>
              </div>
            </div>
          </div>
        </div>
      </div>

{% endblock %}

{% block scripts %}
    <script>
      const filesInput = document.getElementById('files-input');
      const selectedFilesEl = document.getElementById('selected-files');
      const selectedPreview = document.getElementById('selected-preview');
      const mergedPreview = document.getElementById('merged-preview');
      const mergedDownload = document.getElementById('merged-download');
      const mergeButton = document.getElementById('merge-button');
      const mergeForm = document.getElementById('merge-form');
      const driveFolderSection = document.getElementById('drive-folder-section');
      const folderSelect = document.getElementById('folder-select');
      const refreshFoldersBtn = document.getElementById('refresh-folders-btn');
      const newFolderNameInput = document.getElementById('new-folder-name');
      const createFolderBtn = document.getElementById('create-folder-btn');
      const folderStatus = document.getElementById('folder-status');

      // store selected files and per-file metadata (order matters)
      let selectedFilesArray = [];

      function swapArray(arr, i, j) {
        const tmp = arr[i]; arr[i] = arr[j]; arr[j] = tmp;
      }

      function renderSelectedList() {
        selectedFilesEl.innerHTML = '';
        if (!selectedFilesArray.length) {
          const li = document.createElement('li'); li.textContent = 'No files selected.'; selectedFilesEl.appendChild(li);
          selectedPreview.style.display = 'none';
          return;
        }

        selectedFilesArray.forEach((obj, idx) => {
          const f = obj.file;
          const li = document.createElement('li');
          li.draggable = true;

          // drag handle icon
          const dragHandle = document.createElement('span');
          dragHandle.className = 'drag-handle';
          dragHandle.textContent = '‚ãÆ‚ãÆ';
          dragHandle.title = 'Drag to reorder';

          // reorder buttons with enhanced styling
          const up = document.createElement('button'); 
          up.type = 'button'; 
          up.className = 'reorder-btn';
          up.textContent = '‚Üë'; 
          up.title = 'Move up';
          up.disabled = idx === 0;
          
          const down = document.createElement('button'); 
          down.type = 'button'; 
          down.className = 'reorder-btn';
          down.textContent = '‚Üì'; 
          down.title = 'Move down';
          down.disabled = idx === selectedFilesArray.length - 1;
          
          up.addEventListener('click', () => { if (idx > 0) { swapArray(selectedFilesArray, idx, idx-1); renderSelectedList(); } });
          down.addEventListener('click', () => { if (idx < selectedFilesArray.length - 1) { swapArray(selectedFilesArray, idx, idx+1); renderSelectedList(); } });

          const nameSpan = document.createElement('span');
          nameSpan.className = 'file-name';
          nameSpan.textContent = f.name;
          nameSpan.style.flex = '1';
          nameSpan.style.minWidth = '0';
          nameSpan.style.overflow = 'hidden';
          nameSpan.style.textOverflow = 'ellipsis';
          nameSpan.style.whiteSpace = 'nowrap';

          // remove button
          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'remove-btn';
          removeBtn.textContent = '√ó Remove';
          removeBtn.title = 'Remove file';
          removeBtn.addEventListener('click', () => {
            selectedFilesArray.splice(idx, 1);
            renderSelectedList();
          });

          // per-file resize selector
          const sel = document.createElement('select');
          sel.innerHTML = '<option value="preserve">Preserve</option><option value="global">Use global</option><option value="A4">A4 (210√ó297 mm)</option><option value="Letter">Letter (8.5√ó11 in)</option><option value="custom">Custom</option>';
          sel.style.marginRight = '0.4rem';
          sel.value = obj.resize || 'preserve';

          const sizeInput = document.createElement('input');
          sizeInput.placeholder = 'e.g. 8.5inx11in';
          sizeInput.style.display = obj.resize === 'custom' ? '' : 'none';
          sizeInput.style.width = '9rem';
          sizeInput.value = obj.customSize || '';

          sel.addEventListener('change', () => {
            obj.resize = sel.value;
            sizeInput.style.display = sel.value === 'custom' ? '' : 'none';
          });

          sizeInput.addEventListener('input', () => {
            obj.customSize = sizeInput.value;
          });

          nameSpan.addEventListener('click', () => {
            const url = URL.createObjectURL(f);
            const zoom = selectedPreview.dataset.zoom || 'page-width';
            selectedPreview.src = url + '#zoom=' + zoom; selectedPreview.style.display = '';
          });

          // drag and drop handlers
          li.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', String(idx));
            e.dataTransfer.effectAllowed = 'move';
            li.classList.add('dragging');
          });
          li.addEventListener('dragend', () => li.classList.remove('dragging'));
          li.addEventListener('dragover', (e) => { e.preventDefault(); });
          li.addEventListener('drop', (e) => {
            e.preventDefault();
            const from = parseInt(e.dataTransfer.getData('text/plain'), 10);
            const to = idx;
            if (!Number.isNaN(from) && from !== to) {
              const item = selectedFilesArray.splice(from, 1)[0];
              selectedFilesArray.splice(to, 0, item);
              renderSelectedList();
            }
          });

          li.appendChild(dragHandle);
          li.appendChild(up);
          li.appendChild(down);
          li.appendChild(nameSpan);
          li.appendChild(sel);
          li.appendChild(sizeInput);
          li.appendChild(removeBtn);
          li.style.display = 'flex';
          li.style.alignItems = 'center';
          li.style.gap = '0.5rem';
          selectedFilesEl.appendChild(li);
          // auto-preview first file
          if (idx === 0) {
            const url = URL.createObjectURL(f);
            const zoom = selectedPreview.dataset.zoom || 'page-width';
            selectedPreview.src = url + '#zoom=' + zoom; selectedPreview.style.display = '';
          }
        });
      }

      const addMoreButton = document.getElementById('add-more-files');

      filesInput.addEventListener('change', (ev) => {
        const newFiles = Array.from(filesInput.files || []).map(f => ({ file: f, resize: 'preserve', customSize: '' }));
        // Append new files to existing array instead of replacing
        selectedFilesArray = selectedFilesArray.concat(newFiles);
        renderSelectedList();
      });

      addMoreButton.addEventListener('click', () => {
        filesInput.click();
      });

      // Page size select handlers
      const pageSizeSelect = document.getElementById('page-size-select');
      const pageSizeCustom = document.getElementById('page-size-custom');
      const pageSizeHidden = document.getElementById('page-size-hidden');

      pageSizeSelect.addEventListener('change', () => {
        if (pageSizeSelect.value === 'custom') {
          pageSizeCustom.style.display = '';
          pageSizeHidden.value = pageSizeCustom.value;
        } else {
          pageSizeCustom.style.display = 'none';
          pageSizeHidden.value = pageSizeSelect.value;
        }
      });

      pageSizeCustom.addEventListener('input', () => {
        pageSizeHidden.value = pageSizeCustom.value;
      });

      // AJAX submit so we can preview the merged PDF without leaving the page
      mergeForm.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        if (selectedFilesArray.length === 0) {
          alert('Please select at least one PDF file.');
          return;
        }
        mergeButton.disabled = true;
        mergeButton.textContent = 'Merging...';
        mergedPreview.style.display = 'none';
        mergedDownload.style.display = 'none';

        // build FormData manually so we can control file order
        const fd = new FormData();
        // include global page_size
        const pageSizeInput = mergeForm.querySelector('input[name="page_size"]');
        if (pageSizeInput) fd.append('page_size', pageSizeInput.value || '');

        // append files in the current user order and their per-file resize spec
        selectedFilesArray.forEach((obj) => {
          fd.append('files', obj.file, obj.file.name);
          let val = obj.resize || 'preserve';
          if (val === 'custom' && obj.customSize) val = obj.customSize;
          fd.append('file_resize', val);
        });

        try {
          const resp = await fetch(mergeForm.action, { method: 'POST', body: fd });
          if (!resp.ok) throw new Error('Server returned ' + resp.status);
          const blob = await resp.blob();
          mergedBlob = blob;
          const url = URL.createObjectURL(blob);
          const zoom = mergedPreview.dataset.zoom || 'page-width';
          mergedPreview.src = url + '#zoom=' + zoom;
          mergedPreview.style.display = '';
          mergedDownload.href = url;
          // Update download filename from the form input
          const customFilename = document.getElementById('output-filename').value.trim();
          if (customFilename) {
            mergedDownload.download = customFilename.endsWith('.pdf') ? customFilename : customFilename + '.pdf';
          } else {
            mergedDownload.download = 'merged.pdf';
          }
          mergedDownload.style.display = '';
          uploadToDriveBtn.style.display = '';
          document.getElementById('share-whatsapp-btn').style.display = '';
        } catch (err) {
          alert('Error: ' + err.message);
        } finally {
          mergeButton.disabled = false;
          mergeButton.textContent = 'Merge';
        }
      });

        // zoom toggle helpers
      function setPreviewZoom(iframeEl, mode){
        iframeEl.dataset.zoom = mode;
        if (iframeEl.src){
          const base = iframeEl.src.split('#')[0];
          iframeEl.src = base + '#zoom=' + mode;
        }
      }

      function updateToggleButton(btn){
        const target = document.getElementById(btn.dataset.target);
        const mode = target.dataset.zoom || 'page-width';
        if (mode === 'page-width'){
          btn.textContent = 'üîç Fit to width';
          btn.setAttribute('aria-pressed','false');
        } else {
          btn.textContent = 'üîé Actual size';
          btn.setAttribute('aria-pressed','true');
        }
      }

      document.querySelectorAll('.zoom-toggle').forEach(btn => {
        updateToggleButton(btn);
        btn.addEventListener('click', () => {
          const target = document.getElementById(btn.dataset.target);
          const next = (target.dataset.zoom === 'page-width') ? '100' : 'page-width';
          setPreviewZoom(target, next);
          updateToggleButton(btn);
        });
      });

      // Google Drive folder management functions
      async function loadFolders() {
        try {
          const resp = await fetch('/drive/folders');
          const result = await resp.json();
          if (result.folders) {
            folderSelect.innerHTML = '<option value="">Root folder</option>';
            result.folders.forEach(folder => {
              const option = document.createElement('option');
              option.value = folder.id;
              option.textContent = folder.name;
              folderSelect.appendChild(option);
            });
            folderStatus.textContent = `${result.folders.length} folders loaded`;
          }
        } catch (err) {
          folderStatus.textContent = '‚ùå Failed to load folders';
        }
      }

      refreshFoldersBtn.addEventListener('click', async () => {
        refreshFoldersBtn.disabled = true;
        refreshFoldersBtn.textContent = 'üîÑ Loading...';
        await loadFolders();
        refreshFoldersBtn.disabled = false;
        refreshFoldersBtn.textContent = 'üîÑ Refresh';
      });

      createFolderBtn.addEventListener('click', async () => {
        const folderName = newFolderNameInput.value.trim();
        if (!folderName) {
          alert('Please enter a folder name');
          return;
        }

        createFolderBtn.disabled = true;
        createFolderBtn.textContent = '‚è≥ Creating...';
        folderStatus.textContent = 'Creating folder...';

        try {
          const resp = await fetch('/drive/create-folder', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ folder_name: folderName })
          });
          const result = await resp.json();
          
          if (result.error) {
            throw new Error(result.error);
          }

          // Add new folder to dropdown
          const option = document.createElement('option');
          option.value = result.folder_id;
          option.textContent = result.folder_name;
          folderSelect.appendChild(option);
          folderSelect.value = result.folder_id;
          
          newFolderNameInput.value = '';
          folderStatus.textContent = `‚úì Folder "${result.folder_name}" created!`;
        } catch (err) {
          folderStatus.textContent = `‚ùå ${err.message}`;
        } finally {
          createFolderBtn.disabled = false;
          createFolderBtn.textContent = '‚ûï Create Folder';
        }
      });

      // Upload to Drive functionality
      const uploadToDriveBtn = document.getElementById('upload-to-drive-btn');
      let mergedBlob = null;
      
      uploadToDriveBtn.addEventListener('click', async () => {
        if (!mergedBlob) {
          alert('No merged PDF available');
          return;
        }
        
        uploadToDriveBtn.disabled = true;
        uploadToDriveBtn.textContent = 'üì§ Uploading...';
        
        try {
          // Use custom filename from the input, or default to merged.pdf
          let driveFilename = document.getElementById('output-filename').value.trim();
          if (!driveFilename) {
            driveFilename = 'merged.pdf';
          } else if (!driveFilename.toLowerCase().endsWith('.pdf')) {
            driveFilename += '.pdf';
          }
          
          const fd = new FormData();
          fd.append('file', mergedBlob, driveFilename);
          fd.append('filename', driveFilename);
          
          // Add folder ID if selected
          const folderId = folderSelect.value;
          if (folderId) {
            fd.append('folder_id', folderId);
          }
          
          const resp = await fetch('/drive/upload', { method: 'POST', body: fd });
          const result = await resp.json();
          
          if (result.error) {
            throw new Error(result.error);
          }
          
          alert('‚úì Uploaded to Google Drive successfully!\\nFile: ' + result.name);
        } catch (err) {
          alert('Upload failed: ' + err.message + '\\nMake sure you are connected to Google Drive in Settings.');
        } finally {
          uploadToDriveBtn.disabled = false;
          uploadToDriveBtn.textContent = 'üì§ Upload to Drive';
        }
      });

      // Show folder section when upload button appears
      const observer = new MutationObserver(() => {
        if (uploadToDriveBtn.style.display !== 'none' && driveFolderSection.style.display === 'none') {
          driveFolderSection.style.display = '';
          loadFolders();
        }
      });
      observer.observe(uploadToDriveBtn, { attributes: true });

      // WhatsApp share functionality
      const shareWhatsAppBtn = document.getElementById('share-whatsapp-btn');
      
      shareWhatsAppBtn.addEventListener('click', async () => {
        const downloadLink = document.getElementById('merged-download');
        if (!downloadLink.href || downloadLink.href === '#') {
          alert('No merged PDF available. Please merge PDFs first.');
          return;
        }

        try {
          // Get the PDF blob from the download link
          const response = await fetch(downloadLink.href);
          const blob = await response.blob();
          
          // Get custom filename or use default
          const filenameInput = document.getElementById('output-filename');
          let filename = (filenameInput && filenameInput.value.trim()) || 'merged.pdf';
          if (!filename.toLowerCase().endsWith('.pdf')) {
            filename += '.pdf';
          }
          
          const file = new File([blob], filename, { type: 'application/pdf' });

          // Check if Web Share API is supported
          if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
            await navigator.share({
              files: [file],
              title: 'Merged PDF',
              text: 'Sharing merged PDF file'
            });
          } else {
            // Fallback: show instructions
            alert('Web Share is not supported on this browser.\\n\\nTo share via WhatsApp:\\n1. Download the PDF using the Download button\\n2. Open WhatsApp\\n3. Attach the downloaded file');
          }
        } catch (err) {
          if (err.name !== 'AbortError') {
            console.error('Share error:', err);
            alert('Failed to share: ' + err.message);
          }
        }
      });

      // initial state
      renderSelectedList();
    </script>
{% endblock %}